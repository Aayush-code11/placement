<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin (TPO) Dashboard - Placement System</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    /* Dashboard Layout */
    .admin-dashboard { display: grid; gap: 20px; margin: 20px 0; }
    
    /* Stats Cards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card h2 { margin: 0; font-size: 48px; font-weight: bold; }
    .stat-card p { margin: 10px 0 0 0; font-size: 16px; opacity: 0.95; }
    .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card.green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .stat-card.yellow { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    
    /* Card Sections */
    .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .card h3 { margin-top: 0; color: #333; border-bottom: 3px solid #667eea; padding-bottom: 10px; font-size: 22px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #ddd; flex-wrap: wrap; }
    .tab { padding: 12px 25px; cursor: pointer; background: #f5f5f5; border: none; border-radius: 5px 5px 0 0; font-weight: bold; font-size: 15px; transition: all 0.3s; }
    .tab:hover { background: #e0e0e0; }
    .tab.active { background: #667eea; color: white; }
    .tab-content { display: none; padding: 20px 0; }
    .tab-content.active { display: block; }
    
    /* Tables */
    .data-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    .data-table th { background: #667eea; color: white; padding: 12px; text-align: left; font-weight: bold; }
    .data-table td { padding: 10px; border-bottom: 1px solid #eee; }
    .data-table tr:hover { background: #f8f9fa; }
    .data-table tr.pending { background: #fff3cd; }
    .data-table tr.approved { background: #d4edda; }
    .data-table tr.rejected { background: #f8d7da; }
    
    /* Status Badges */
    .status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .status-applied { background: #d1ecf1; color: #0c5460; }
    .status-shortlisted { background: #e2d9f3; color: #6f42c1; }
    .status-interviewed { background: #cce5ff; color: #004085; }
    .status-selected { background: #d4edda; color: #155724; }
    
    /* Forms */
    .admin-form { display: grid; gap: 15px; max-width: 800px; }
    .admin-form label { font-weight: 500; display: flex; flex-direction: column; gap: 5px; }
    .admin-form input, .admin-form select, .admin-form textarea { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .admin-form textarea { min-height: 100px; resize: vertical; }
    .admin-form button { padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .admin-form button:hover { background: #218838; }
    
    /* Action Buttons */
    .action-btn { padding: 8px 15px; margin: 0 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; transition: all 0.2s; }
    .btn-approve { background: #28a745; color: white; }
    .btn-approve:hover { background: #218838; }
    .btn-reject { background: #dc3545; color: white; }
    .btn-reject:hover { background: #c82333; }
    .btn-view { background: #007bff; color: white; }
    .btn-view:hover { background: #0056b3; }
    .btn-download { background: #17a2b8; color: white; }
    .btn-download:hover { background: #138496; }
    .btn-edit { background: #ffc107; color: #333; }
    .btn-edit:hover { background: #e0a800; }
    
    /* Notification Banner */
    .notification-banner { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
    .notification-banner h4 { margin: 0 0 10px 0; font-size: 20px; }
    .notification-banner p { margin: 5px 0; opacity: 0.95; }
    
    /* No Data */
    .no-data { text-align: center; padding: 40px; color: #999; font-size: 16px; }
    
    /* Auth Required */
    .auth-required { text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 10px; margin: 40px auto; max-width: 600px; }
    .auth-required h2 { color: #333; margin-bottom: 20px; }
    .auth-required p { color: #666; font-size: 18px; margin-bottom: 30px; }
    .auth-buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
    .auth-btn { padding: 15px 40px; font-size: 18px; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; text-decoration: none; display: inline-block; transition: transform 0.2s; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .login-btn { background: #007bff; color: white; }
    .register-btn { background: #28a745; color: white; }
    
    /* Loading */
    .loading { text-align: center; padding: 20px; color: #667eea; font-weight: bold; }
    
    @media (max-width: 768px) { 
      .stats-grid { grid-template-columns: 1fr 1fr; }
      .tabs { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üéì Admin (TPO) Dashboard</h1>
    <nav>
      <a href="/">Home</a> | 
      <a href="/logout">Logout</a>
    </nav>
  </header>
  
  <main class="container">
    <!-- Auth Required Message -->
    <div id="authRequired" class="auth-required" style="display: none;">
      <h2>üîí Admin Login Required</h2>
      <p>Please login as Admin/TPO to access the dashboard</p>
      <div class="auth-buttons">
        <a href="/login.html" class="auth-btn login-btn">üîê Login as Admin</a>
        <a href="/register.html" class="auth-btn register-btn">üìù Register as Admin</a>
      </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" style="display: none;">
      
      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <h2 id="totalStudents">0</h2>
          <p>üë®‚Äçüéì Total Students</p>
        </div>
        <div class="stat-card orange">
          <h2 id="totalCompanies">0</h2>
          <p>üè¢ Total Companies</p>
        </div>
        <div class="stat-card blue">
          <h2 id="totalApplications">0</h2>
          <p>üìã Total Applications</p>
        </div>
        <div class="stat-card green">
          <h2 id="totalPlacements">0</h2>
          <p>‚úÖ Placed Students</p>
        </div>
        <div class="stat-card yellow">
          <h2 id="pendingApprovals">0</h2>
          <p>‚è≥ Pending Approvals</p>
        </div>
      </div>

      <!-- Notification Banner -->
      <div class="notification-banner">
        <h4>üì¢ Quick Actions</h4>
        <p>Manage placement activities, approve registrations, post notifications, and generate reports</p>
      </div>

      <!-- Main Tabs -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" onclick="switchAdminTab('overview')">üìä Overview</button>
          <button class="tab" onclick="switchAdminTab('students')">üë®‚Äçüéì Students</button>
          <button class="tab" onclick="switchAdminTab('companies')">üè¢ Companies</button>
          <button class="tab" onclick="switchAdminTab('applications')">üìã Applications</button>
          <button class="tab" onclick="switchAdminTab('approvals')">‚úÖ Approvals</button>
          <button class="tab" onclick="switchAdminTab('notifications')">üì¢ Notifications</button>
          <button class="tab" onclick="switchAdminTab('reports')">üìà Reports</button>
        </div>

        <!-- Overview Tab -->
        <div id="overviewTab" class="tab-content active">
          <h3>üìä Placement Overview & Analytics</h3>
          <div id="overviewStats">
            <p class="loading">Loading analytics...</p>
          </div>
        </div>

        <!-- Students Tab -->
        <div id="studentsTab" class="tab-content">
          <h3>üë®‚Äçüéì Student Management</h3>
          <div style="margin-bottom: 20px;">
            <button onclick="showAddStudentForm()" class="action-btn btn-approve">‚ûï Add New Student</button>
            <button onclick="loadStudentsData()" class="action-btn btn-view">üîÑ Refresh</button>
          </div>
          
          <div id="addStudentForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4>Add New Student</h4>
            <form action="/students" method="post" enctype="multipart/form-data" class="admin-form">
              <label>Name <input name="name" required placeholder="Full Name"></label>
              <label>Roll Number <input name="roll" required placeholder="Student Roll Number"></label>
              <label>Branch/Department <input name="branch" required placeholder="e.g., Computer Science"></label>
              <label>CGPA <input name="cgpa" required type="number" step="0.01" min="0" max="10" placeholder="e.g., 8.5"></label>
              <label>Email <input name="email" required type="email" placeholder="student@example.com"></label>
              <label>Resume (PDF) <input name="resume" type="file" accept="application/pdf"></label>
              <button type="submit">üíæ Add Student</button>
            </form>
          </div>
          
          <div id="studentsData">
            <p class="loading">Loading students...</p>
          </div>
        </div>

        <!-- Companies Tab -->
        <div id="companiesTab" class="tab-content">
          <h3>üè¢ Company Management</h3>
          <div style="margin-bottom: 20px;">
            <button onclick="showAddCompanyForm()" class="action-btn btn-approve">‚ûï Add New Company</button>
            <button onclick="loadCompaniesData()" class="action-btn btn-view">üîÑ Refresh</button>
          </div>
          
          <div id="addCompanyForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4>Add New Company / Job Drive</h4>
            <form action="/companies" method="post" class="admin-form">
              <label>Company Name <input name="name" required placeholder="Company Name"></label>
              <label>HR Email <input name="hrEmail" required type="email" placeholder="hr@company.com"></label>
              <label>Job Role <input name="role" required placeholder="e.g., Software Engineer"></label>
              <label>CTC (Package) <input name="ctc" placeholder="e.g., 12 LPA"></label>
              <label>Location <input name="location" placeholder="e.g., Bangalore, Hyderabad"></label>
              <label>Minimum CGPA <input name="minCgpa" required type="number" step="0.01" min="0" max="10" placeholder="e.g., 7.0"></label>
              <label>Eligible Branches (comma-separated) <input name="branches" required placeholder="e.g., CSE, IT, ECE"></label>
              <label>Number of Openings <input name="openings" type="number" min="1" placeholder="e.g., 10"></label>
              <label>Job Description <textarea name="jobDescription" placeholder="Job responsibilities and requirements..."></textarea></label>
              <button type="submit">üíæ Add Company</button>
            </form>
          </div>
          
          <div id="companiesData">
            <p class="loading">Loading companies...</p>
          </div>
        </div>

        <!-- Applications Tab -->
        <div id="applicationsTab" class="tab-content">
          <h3>üìã Application Management</h3>
          <div style="margin-bottom: 20px;">
            <button onclick="loadApplicationsData()" class="action-btn btn-view">üîÑ Refresh Applications</button>
          </div>
          <div id="applicationsData">
            <p class="loading">Loading applications...</p>
          </div>
        </div>

        <!-- Approvals Tab -->
        <div id="approvalsTab" class="tab-content">
          <h3>‚úÖ Pending Approvals</h3>
          <p style="color: #666;">Note: This feature will approve/reject new student and company registrations (currently auto-approved)</p>
          <div id="approvalsData">
            <p class="no-data">All registrations are currently auto-approved. Manual approval system coming soon!</p>
          </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notificationsTab" class="tab-content">
          <h3>üì¢ Post Notifications & Announcements</h3>
          <div class="admin-form" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <label>Notification Title <input id="notifTitle" placeholder="e.g., Upcoming Placement Drive"></label>
            <label>Notification Message <textarea id="notifMessage" placeholder="Details about the announcement..."></textarea></label>
            <label>Target Audience 
              <select id="notifTarget">
                <option value="all">All (Students & Companies)</option>
                <option value="students">Students Only</option>
                <option value="companies">Companies Only</option>
              </select>
            </label>
            <button onclick="postNotification()">üì¢ Post Notification</button>
          </div>
          
          <h4>Recent Notifications</h4>
          <div id="notificationsList">
            <p class="no-data">No notifications posted yet</p>
          </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
          <h3>üìà Reports & Analytics</h3>
          <div style="display: grid; gap: 15px; margin: 20px 0;">
            <button onclick="generatePlacedReport()" class="action-btn btn-view">üìä Placed Students Report</button>
            <button onclick="generateUnplacedReport()" class="action-btn btn-view">üìä Unplaced Students Report</button>
            <button onclick="generateCompanyVisitsReport()" class="action-btn btn-view">üìä Company Visits Report</button>
            <button onclick="generateBranchWiseReport()" class="action-btn btn-view">üìä Branch-wise Placement Report</button>
            <button onclick="downloadAllData()" class="action-btn btn-download">üíæ Download Complete Data (CSV)</button>
          </div>
          
          <div id="reportData" style="margin-top: 20px;">
            <p class="no-data">Click a button above to generate reports</p>
          </div>
        </div>

      </div>
    </div>
  </main>
  
  <script src="/js/app.js"></script>
  <script>
    let isAdminAuthenticated = false;
    let studentsData = [];
    let companiesData = [];
    let applicationsData = [];

    // Check Admin Authentication
    async function checkAdminAuth() {
      try {
        const res = await fetch('/api/admin/check');
        const data = await res.json();
        if (data.isAdmin) {
          document.getElementById('authRequired').style.display = 'none';
          document.getElementById('dashboardContent').style.display = 'block';
          isAdminAuthenticated = true;
          loadDashboardData();
        } else {
          document.getElementById('authRequired').style.display = 'block';
          document.getElementById('dashboardContent').style.display = 'none';
        }
      } catch (err) {
        document.getElementById('authRequired').style.display = 'block';
        document.getElementById('dashboardContent').style.display = 'none';
      }
    }

    // Load All Dashboard Data
    async function loadDashboardData() {
      try {
        const [students, companies, applications] = await Promise.all([
          fetch('/api/students').then(r => r.json()),
          fetch('/api/companies').then(r => r.json()),
          fetch('/api/applications').then(r => r.json())
        ]);
        
        studentsData = students;
        companiesData = companies;
        applicationsData = applications;
        
        // Update Statistics
        document.getElementById('totalStudents').textContent = students.length;
        document.getElementById('totalCompanies').textContent = companies.length;
        document.getElementById('totalApplications').textContent = applications.length;
        
        const placed = applications.filter(a => a.status && a.status.toLowerCase() === 'selected').length;
        document.getElementById('totalPlacements').textContent = placed;
        document.getElementById('pendingApprovals').textContent = '0'; // Auto-approved for now
        
        // Load Overview
        loadOverviewData();
      } catch (err) {
        console.error('Error loading dashboard data:', err);
      }
    }

    // Load Overview Tab
    function loadOverviewData() {
      const placed = applicationsData.filter(a => a.status && a.status.toLowerCase() === 'selected').length;
      const unplaced = studentsData.length - placed;
      const avgCGPA = studentsData.length > 0 ? (studentsData.reduce((sum, s) => sum + (s.cgpa || 0), 0) / studentsData.length).toFixed(2) : '0';
      
      // Branch-wise stats
      const branchStats = {};
      studentsData.forEach(s => {
        const branch = s.branch || 'Unknown';
        branchStats[branch] = (branchStats[branch] || 0) + 1;
      });
      
      let branchHTML = '<h4>Branch-wise Student Distribution:</h4><ul>';
      for (const [branch, count] of Object.entries(branchStats)) {
        branchHTML += `<li><strong>${branch}:</strong> ${count} students</li>`;
      }
      branchHTML += '</ul>';
      
      document.getElementById('overviewStats').innerHTML = `
        <div style="display: grid; gap: 20px;">
          <div style="padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4>Placement Statistics</h4>
            <p><strong>Total Students:</strong> ${studentsData.length}</p>
            <p><strong>Placed Students:</strong> ${placed} (${studentsData.length > 0 ? ((placed/studentsData.length)*100).toFixed(1) : 0}%)</p>
            <p><strong>Unplaced Students:</strong> ${unplaced}</p>
            <p><strong>Average CGPA:</strong> ${avgCGPA}</p>
          </div>
          <div style="padding: 20px; background: #f8f9fa; border-radius: 10px;">
            ${branchHTML}
          </div>
          <div style="padding: 20px; background: #f8f9fa; border-radius: 10px;">
            <h4>Company Statistics</h4>
            <p><strong>Total Companies:</strong> ${companiesData.length}</p>
            <p><strong>Total Job Openings:</strong> ${companiesData.reduce((sum, c) => sum + (c.openings || 0), 0)}</p>
          </div>
        </div>
      `;
    }

    // Load Students Data
    function loadStudentsData() {
      if (studentsData.length === 0) {
        document.getElementById('studentsData').innerHTML = '<p class="no-data">No students registered yet</p>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Roll No</th><th>Branch</th><th>CGPA</th><th>Email</th><th>Resume</th><th>Actions</th></tr></thead><tbody>';
      studentsData.forEach(s => {
        html += `<tr>
          <td>${s.id}</td>
          <td>${s.name || 'N/A'}</td>
          <td>${s.roll || 'N/A'}</td>
          <td>${s.branch || 'N/A'}</td>
          <td>${s.cgpa || 'N/A'}</td>
          <td>${s.email || 'N/A'}</td>
          <td>${s.resumeFileName ? '‚úÖ Uploaded' : '‚ùå Not uploaded'}</td>
          <td>
            ${s.resumeFileName ? `<button class="action-btn btn-download" onclick="downloadResume(${s.id})">üì• Resume</button>` : ''}
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('studentsData').innerHTML = html;
    }

    // Load Companies Data
    function loadCompaniesData() {
      if (companiesData.length === 0) {
        document.getElementById('companiesData').innerHTML = '<p class="no-data">No companies registered yet</p>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>ID</th><th>Company</th><th>Role</th><th>CTC</th><th>Location</th><th>Min CGPA</th><th>Branches</th><th>Openings</th><th>Applications</th></tr></thead><tbody>';
      companiesData.forEach(c => {
        const apps = applicationsData.filter(a => a.company && a.company.id === c.id).length;
        html += `<tr>
          <td>${c.id}</td>
          <td>${c.name || 'N/A'}</td>
          <td>${c.role || 'N/A'}</td>
          <td>${c.ctc || 'N/A'}</td>
          <td>${c.location || 'N/A'}</td>
          <td>${c.minCgpa || 'N/A'}</td>
          <td>${c.branches || 'N/A'}</td>
          <td>${c.openings || 'N/A'}</td>
          <td><strong>${apps}</strong> applications</td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('companiesData').innerHTML = html;
    }

    // Load Applications Data
    function loadApplicationsData() {
      if (applicationsData.length === 0) {
        document.getElementById('applicationsData').innerHTML = '<p class="no-data">No applications submitted yet</p>';
        return;
      }
      
      let html = '<table class="data-table"><thead><tr><th>App ID</th><th>Student</th><th>Roll No</th><th>Company</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
      applicationsData.forEach(a => {
        const statusClass = a.status ? `status-${a.status.toLowerCase()}` : 'status-applied';
        html += `<tr>
          <td>${a.id}</td>
          <td>${a.student ? a.student.name : 'N/A'}</td>
          <td>${a.student ? a.student.roll : 'N/A'}</td>
          <td>${a.company ? a.company.name : 'N/A'}</td>
          <td>${a.company ? a.company.role : 'N/A'}</td>
          <td><span class="status-badge ${statusClass}">${a.status || 'Applied'}</span></td>
          <td>
            <select onchange="updateApplicationStatus(${a.id}, this.value)" style="padding: 5px;">
              <option value="">Update Status</option>
              <option value="Shortlisted">Shortlisted</option>
              <option value="Interviewed">Interviewed</option>
              <option value="Selected">Selected ‚úÖ</option>
              <option value="Rejected">Rejected</option>
            </select>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      document.getElementById('applicationsData').innerHTML = html;
    }

    // Update Application Status
    async function updateApplicationStatus(appId, newStatus) {
      if (!newStatus) return;
      try {
        const res = await fetch(`/api/applications/${appId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `status=${encodeURIComponent(newStatus)}`
        });
        if (res.ok) {
          alert('Status updated successfully!');
          loadDashboardData();
        } else {
          alert('Error updating status');
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Download Resume
    async function downloadResume(studentId) {
      try {
        const resp = await fetch('/resume/' + studentId);
        if (!resp.ok) {
          alert('Resume not found or error downloading');
          return;
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `resume_${studentId}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert('Error downloading resume: ' + err.message);
      }
    }

    // Post Notification
    function postNotification() {
      const title = document.getElementById('notifTitle').value;
      const message = document.getElementById('notifMessage').value;
      const target = document.getElementById('notifTarget').value;
      
      if (!title || !message) {
        alert('Please fill in both title and message');
        return;
      }
      
      alert(`Notification posted!\nTitle: ${title}\nTarget: ${target}\n(Note: Notification system will be integrated with database)`);
      document.getElementById('notifTitle').value = '';
      document.getElementById('notifMessage').value = '';
    }

    // Generate Reports
    function generatePlacedReport() {
      const placed = applicationsData.filter(a => a.status && a.status.toLowerCase() === 'selected');
      let html = `<h4>Placed Students Report (${placed.length} students)</h4>`;
      if (placed.length === 0) {
        html += '<p class="no-data">No students placed yet</p>';
      } else {
        html += '<table class="data-table"><thead><tr><th>Student Name</th><th>Roll No</th><th>Branch</th><th>CGPA</th><th>Company</th><th>Role</th><th>CTC</th></tr></thead><tbody>';
        placed.forEach(a => {
          html += `<tr class="approved">
            <td>${a.student ? a.student.name : 'N/A'}</td>
            <td>${a.student ? a.student.roll : 'N/A'}</td>
            <td>${a.student ? a.student.branch : 'N/A'}</td>
            <td>${a.student ? a.student.cgpa : 'N/A'}</td>
            <td>${a.company ? a.company.name : 'N/A'}</td>
            <td>${a.company ? a.company.role : 'N/A'}</td>
            <td>${a.company ? a.company.ctc : 'N/A'}</td>
          </tr>`;
        });
        html += '</tbody></table>';
      }
      document.getElementById('reportData').innerHTML = html;
    }

    function generateUnplacedReport() {
      const placedStudentIds = applicationsData.filter(a => a.status && a.status.toLowerCase() === 'selected').map(a => a.student ? a.student.id : null);
      const unplaced = studentsData.filter(s => !placedStudentIds.includes(s.id));
      
      let html = `<h4>Unplaced Students Report (${unplaced.length} students)</h4>`;
      if (unplaced.length === 0) {
        html += '<p class="no-data">All students are placed! üéâ</p>';
      } else {
        html += '<table class="data-table"><thead><tr><th>Name</th><th>Roll No</th><th>Branch</th><th>CGPA</th><th>Email</th><th>Applications</th></tr></thead><tbody>';
        unplaced.forEach(s => {
          const apps = applicationsData.filter(a => a.student && a.student.id === s.id).length;
          html += `<tr>
            <td>${s.name || 'N/A'}</td>
            <td>${s.roll || 'N/A'}</td>
            <td>${s.branch || 'N/A'}</td>
            <td>${s.cgpa || 'N/A'}</td>
            <td>${s.email || 'N/A'}</td>
            <td>${apps} applications</td>
          </tr>`;
        });
        html += '</tbody></table>';
      }
      document.getElementById('reportData').innerHTML = html;
    }

    function generateCompanyVisitsReport() {
      let html = '<h4>Company Visits & Hiring Report</h4>';
      if (companiesData.length === 0) {
        html += '<p class="no-data">No companies registered yet</p>';
      } else {
        html += '<table class="data-table"><thead><tr><th>Company</th><th>Role</th><th>Applications</th><th>Shortlisted</th><th>Interviewed</th><th>Selected</th></tr></thead><tbody>';
        companiesData.forEach(c => {
          const apps = applicationsData.filter(a => a.company && a.company.id === c.id);
          const shortlisted = apps.filter(a => a.status && a.status.toLowerCase() === 'shortlisted').length;
          const interviewed = apps.filter(a => a.status && a.status.toLowerCase() === 'interviewed').length;
          const selected = apps.filter(a => a.status && a.status.toLowerCase() === 'selected').length;
          
          html += `<tr>
            <td>${c.name || 'N/A'}</td>
            <td>${c.role || 'N/A'}</td>
            <td>${apps.length}</td>
            <td>${shortlisted}</td>
            <td>${interviewed}</td>
            <td><strong>${selected}</strong></td>
          </tr>`;
        });
        html += '</tbody></table>';
      }
      document.getElementById('reportData').innerHTML = html;
    }

    function generateBranchWiseReport() {
      const branchStats = {};
      studentsData.forEach(s => {
        const branch = s.branch || 'Unknown';
        if (!branchStats[branch]) {
          branchStats[branch] = { total: 0, placed: 0, avgCGPA: 0, cgpaSum: 0 };
        }
        branchStats[branch].total++;
        branchStats[branch].cgpaSum += (s.cgpa || 0);
        
        const isPlaced = applicationsData.some(a => a.student && a.student.id === s.id && a.status && a.status.toLowerCase() === 'selected');
        if (isPlaced) branchStats[branch].placed++;
      });
      
      let html = '<h4>Branch-wise Placement Report</h4>';
      html += '<table class="data-table"><thead><tr><th>Branch</th><th>Total Students</th><th>Placed</th><th>Unplaced</th><th>Placement %</th><th>Avg CGPA</th></tr></thead><tbody>';
      
      for (const [branch, stats] of Object.entries(branchStats)) {
        const placementPercent = stats.total > 0 ? ((stats.placed / stats.total) * 100).toFixed(1) : '0';
        const avgCGPA = stats.total > 0 ? (stats.cgpaSum / stats.total).toFixed(2) : '0';
        
        html += `<tr>
          <td><strong>${branch}</strong></td>
          <td>${stats.total}</td>
          <td>${stats.placed}</td>
          <td>${stats.total - stats.placed}</td>
          <td>${placementPercent}%</td>
          <td>${avgCGPA}</td>
        </tr>`;
      }
      html += '</tbody></table>';
      document.getElementById('reportData').innerHTML = html;
    }

    function downloadAllData() {
      alert('CSV Download feature will be implemented. This will download complete placement data in CSV format.');
    }

    // Toggle Forms
    function showAddStudentForm() {
      const form = document.getElementById('addStudentForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function showAddCompanyForm() {
      const form = document.getElementById('addCompanyForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    // Switch Tabs
    function switchAdminTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Load data when switching tabs
      if (tabName === 'students') loadStudentsData();
      else if (tabName === 'companies') loadCompaniesData();
      else if (tabName === 'applications') loadApplicationsData();
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', checkAdminAuth);
  </script>
</body>
</html>
