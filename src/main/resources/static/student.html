<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Dashboard - Placement</title>
  <link rel="stylesheet" href="/css/style.css" />
  <style>
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    .card { background: #f5f5f5; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .card h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    .profile-info { display: grid; gap: 10px; }
    .profile-info p { margin: 5px 0; }
    .profile-info strong { display: inline-block; width: 120px; }
    
    /* Company Cards */
    .company-card { background: white; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 5px solid #28a745; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .company-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .company-card h4 { margin: 0 0 15px 0; color: #28a745; font-size: 20px; }
    .company-card .job-details { display: grid; gap: 8px; margin: 10px 0; }
    .company-card .job-details p { margin: 0; color: #555; }
    .company-card .job-details strong { color: #333; }
    .company-card button { margin-top: 15px; padding: 10px 30px; font-weight: bold; }
    .company-card button:disabled { background: #ccc; cursor: not-allowed; }
    .eligibility-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-left: 10px; }
    .eligible { background: #d4edda; color: #155724; }
    .not-eligible { background: #f8d7da; color: #721c24; }
    
    /* Application Status */
    .app-status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 13px; font-weight: bold; }
    .status-applied { background: #fff3cd; color: #856404; }
    .status-shortlisted { background: #d1ecf1; color: #0c5460; }
    .status-interviewed { background: #e2d9f3; color: #6f42c1; }
    .status-selected { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    
    /* Announcements */
    .announcement { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; margin: 20px 0; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
    .announcement h4 { margin: 0 0 10px 0; font-size: 16px; }
    .announcement p { margin: 5px 0; font-size: 14px; }
    
    /* Stats Cards */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
    .stat-card h2 { margin: 0; font-size: 36px; }
    .stat-card p { margin: 5px 0 0 0; font-size: 14px; opacity: 0.9; }
    
    .no-data { text-align: center; padding: 20px; color: #999; }
    .auth-required { text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 10px; margin: 40px auto; max-width: 600px; }
    .auth-required h2 { color: #333; margin-bottom: 20px; }
    .auth-required p { color: #666; font-size: 18px; margin-bottom: 30px; }
    .auth-buttons { display: flex; gap: 20px; justify-content: center; }
    .auth-btn { padding: 15px 40px; font-size: 18px; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; text-decoration: none; display: inline-block; transition: transform 0.2s; }
    .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .login-btn { background: #007bff; color: white; }
    .register-btn { background: #28a745; color: white; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #ddd; }
    .tab { padding: 10px 20px; cursor: pointer; background: #f5f5f5; border: none; border-radius: 5px 5px 0 0; font-weight: bold; }
    .tab.active { background: #007bff; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    @media (max-width: 768px) { 
      .dashboard { grid-template-columns: 1fr; } 
      .stats { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üéì Student Dashboard</h1>
    <nav>
      <a href="/">Home</a> | 
      <a href="/logout">Logout</a>
    </nav>
  </header>
  <main class="container">
    <!-- Auth Required Message (shown if not logged in) -->
    <div id="authRequired" class="auth-required" style="display: none;">
      <h2>üîí Login Required</h2>
      <p>Please login or register to access the Student Dashboard</p>
      <div class="auth-buttons">
        <a href="/login.html" class="auth-btn login-btn">üîê Login</a>
        <a href="/register.html" class="auth-btn register-btn">üìù Register as Student</a>
      </div>
    </div>

    <!-- Dashboard Content (shown if logged in) -->
    <div id="dashboardContent" style="display: none;">
    
    <!-- Statistics -->
    <div class="stats">
      <div class="stat-card">
        <h2 id="totalApps">0</h2>
        <p>Total Applications</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h2 id="shortlistedCount">0</h2>
        <p>Shortlisted</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <h2 id="interviewedCount">0</h2>
        <p>Interviewed</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <h2 id="selectedCount">0</h2>
        <p>Selected</p>
      </div>
    </div>
    
    <!-- Announcements Section -->
    <div class="announcement">
      <h4>üì¢ Latest Announcements</h4>
      <p>üéØ Check your eligibility for new job drives below</p>
      <p>üìù Keep your profile and resume updated</p>
      <p>‚úÖ Track your application status in real-time</p>
    </div>
    
    <div class="dashboard">
      <!-- Profile Card -->
      <div class="card">
        <h3>üë§ My Profile</h3>
        <div id="profileInfo" class="profile-info">
          <p>Loading...</p>
        </div>
        <button onclick="toggleUpdateForm()" style="margin-top: 15px;">‚úèÔ∏è Update Profile</button>
        
        <div id="updateForm" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
          <h4>Update Academic & Personal Details</h4>
          <form action="/students" method="post" enctype="multipart/form-data">
            <input type="hidden" name="name" id="updateName">
            <input type="hidden" name="roll" id="updateRoll">
            <label>Branch/Department <input name="branch" id="updateBranch" required placeholder="e.g., Computer Science"></label>
            <label>CGPA <input name="cgpa" id="updateCgpa" required type="number" step="0.01" min="0" max="10" placeholder="e.g., 8.5"></label>
            <label>Email <input name="email" id="updateEmail" required type="email" placeholder="your.email@example.com"></label>
            <label>Upload Resume (PDF) <input name="resume" type="file" accept="application/pdf"></label>
            <button type="submit">üíæ Save Changes</button>
          </form>
        </div>
      </div>

      <!-- Applications Status Card -->
      <div class="card">
        <h3>üìã My Applications & Status</h3>
        <div id="applicationsStatus">
          <p class="no-data">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Tabs for Job Opportunities -->
    <div class="card" style="margin-top: 20px;">
      <h3>üè¢ Job Opportunities & Placement Drives</h3>
      
      <div class="tabs">
        <button class="tab active" onclick="switchTab('eligible')">‚úÖ Eligible for Me</button>
        <button class="tab" onclick="switchTab('all')">üìã All Companies</button>
      </div>
      
      <!-- Eligible Companies Tab -->
      <div id="eligibleTab" class="tab-content active">
        <p style="color: #666; font-size: 14px; margin: 15px 0;">Companies matching your CGPA and department eligibility.</p>
        <div id="eligibleCompanies">
          <p class="no-data">Loading...</p>
        </div>
      </div>
      
      <!-- All Companies Tab -->
      <div id="allTab" class="tab-content">
        <p style="color: #666; font-size: 14px; margin: 15px 0;">All available job opportunities (eligibility criteria shown).</p>
        <div id="allCompanies">
          <p class="no-data">Loading...</p>
        </div>
      </div>
    </div>

    </div>
    <!-- End Dashboard Content -->

  </main>
  
  <script>
    let currentStudent = null;
    let isAuthenticated = false;
    let allCompaniesData = [];
    let appliedCompanyIds = [];

    // Check if user is authenticated
    async function checkAuth() {
      try {
        const res = await fetch('/api/student/me');
        const data = await res.json();
        if (data.error) {
          document.getElementById('authRequired').style.display = 'block';
          document.getElementById('dashboardContent').style.display = 'none';
          isAuthenticated = false;
        } else {
          document.getElementById('authRequired').style.display = 'none';
          document.getElementById('dashboardContent').style.display = 'block';
          isAuthenticated = true;
          currentStudent = data;
          loadProfile();
          loadApplications();
          loadEligibleCompanies();
          loadAllCompanies();
        }
      } catch (e) {
        document.getElementById('authRequired').style.display = 'block';
        document.getElementById('dashboardContent').style.display = 'none';
        isAuthenticated = false;
      }
    }

    // Load student profile
    async function loadProfile() {
      try {
        const res = await fetch('/api/student/me');
        const data = await res.json();
        if (data.error) {
          document.getElementById('profileInfo').innerHTML = `<p style="color: red;">${data.error}</p><p>Please contact admin to link your profile.</p>`;
          return;
        }
        currentStudent = data;
        document.getElementById('profileInfo').innerHTML = `
          <p><strong>Name:</strong> ${data.name || 'N/A'}</p>
          <p><strong>Roll No:</strong> ${data.roll || 'N/A'}</p>
          <p><strong>Department:</strong> ${data.branch || 'N/A'}</p>
          <p><strong>CGPA:</strong> ${data.cgpa || 'N/A'}</p>
          <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
          <p><strong>Resume:</strong> ${data.resumeFileName ? '‚úÖ Uploaded' : '‚ùå Not uploaded'}</p>
        `;
        
        // Populate update form
        document.getElementById('updateName').value = data.name || '';
        document.getElementById('updateRoll').value = data.roll || '';
        document.getElementById('updateBranch').value = data.branch || '';
        document.getElementById('updateCgpa').value = data.cgpa || '';
        document.getElementById('updateEmail').value = data.email || '';
      } catch (e) {
        document.getElementById('profileInfo').innerHTML = `<p style="color: red;">Error loading profile</p>`;
      }
    }

    // Load applications and update stats
    async function loadApplications() {
      try {
        const res = await fetch('/api/student/my-applications');
        const apps = await res.json();
        
        // Update stats
        document.getElementById('totalApps').textContent = apps.length || 0;
        document.getElementById('shortlistedCount').textContent = apps.filter(a => a.status === 'Shortlisted').length;
        document.getElementById('interviewedCount').textContent = apps.filter(a => a.status === 'Interviewed').length;
        document.getElementById('selectedCount').textContent = apps.filter(a => a.status === 'Selected').length;
        
        // Store applied company IDs
        appliedCompanyIds = apps.map(a => a.company?.id).filter(id => id);
        
        if (!apps || apps.length === 0) {
          document.getElementById('applicationsStatus').innerHTML = '<p class="no-data">No applications yet. Start applying to companies!</p>';
          return;
        }
        
        let html = '<div style="max-height: 300px; overflow-y: auto;">';
        apps.forEach(app => {
          const statusClass = `status-${app.status.toLowerCase().replace(' ', '-')}`;
          const statusIcon = {
            'Applied': 'üìù',
            'Shortlisted': '‚úÖ',
            'Interviewed': 'üé§',
            'Selected': 'üéâ',
            'Rejected': '‚ùå'
          };
          html += `
            <div style="background: white; padding: 12px; margin: 8px 0; border-radius: 5px; border-left: 3px solid #007bff;">
              <strong>${app.company?.name || 'Company'}</strong>
              <p style="margin: 5px 0; color: #666; font-size: 13px;">${app.company?.role || 'Position'}</p>
              <span class="app-status ${statusClass}">${statusIcon[app.status] || 'üìå'} ${app.status}</span>
            </div>
          `;
        });
        html += '</div>';
        document.getElementById('applicationsStatus').innerHTML = html;
      } catch (e) {
        document.getElementById('applicationsStatus').innerHTML = '<p class="no-data">Error loading applications</p>';
      }
    }

    // Check eligibility
    function isEligible(company) {
      if (!currentStudent) return false;
      const studentCgpa = parseFloat(currentStudent.cgpa) || 0;
      const minCgpa = parseFloat(company.minCgpa) || 0;
      const branches = (company.branches || '').toLowerCase().split(',').map(b => b.trim());
      const studentBranch = (currentStudent.branch || '').toLowerCase().trim();
      
      const cgpaOk = studentCgpa >= minCgpa;
      const branchOk = !company.branches || company.branches === '' || branches.includes(studentBranch) || branches.includes('all');
      
      return cgpaOk && branchOk;
    }

    // Load eligible companies
    async function loadEligibleCompanies() {
      try {
        const res = await fetch('/api/student/eligible-companies');
        const companies = await res.json();
        if (!companies || companies.length === 0) {
          document.getElementById('eligibleCompanies').innerHTML = '<p class="no-data">No companies available matching your profile. Keep checking for new opportunities!</p>';
          return;
        }
        
        document.getElementById('eligibleCompanies').innerHTML = renderCompanies(companies, true);
      } catch (e) {
        document.getElementById('eligibleCompanies').innerHTML = '<p class="no-data">Error loading companies</p>';
      }
    }

    // Load all companies
    async function loadAllCompanies() {
      try {
        const res = await fetch('/api/companies');
        const companies = await res.json();
        allCompaniesData = companies;
        if (!companies || companies.length === 0) {
          document.getElementById('allCompanies').innerHTML = '<p class="no-data">No companies posted yet</p>';
          return;
        }
        
        document.getElementById('allCompanies').innerHTML = renderCompanies(companies, false);
      } catch (e) {
        document.getElementById('allCompanies').innerHTML = '<p class="no-data">Error loading companies</p>';
      }
    }

    // Render companies
    function renderCompanies(companies, onlyEligible) {
      let html = '';
      companies.forEach(c => {
        const eligible = isEligible(c);
        const alreadyApplied = appliedCompanyIds.includes(c.id);
        
        if (onlyEligible && !eligible) return; // Skip non-eligible in eligible tab
        
        html += `
          <div class="company-card">
            <h4>üè¢ ${c.name} ${eligible ? '<span class="eligibility-badge eligible">‚úÖ Eligible</span>' : '<span class="eligibility-badge not-eligible">‚ùå Not Eligible</span>'}</h4>
            <div class="job-details">
              <p><strong>üìå Position:</strong> ${c.role || 'N/A'}</p>
              <p><strong>üí∞ Package (CTC):</strong> ${c.ctc || 'Not disclosed'}</p>
              <p><strong>üìç Location:</strong> ${c.location || 'Not specified'}</p>
              <p><strong>üéØ Min CGPA Required:</strong> ${c.minCgpa || 'N/A'}</p>
              <p><strong>üéì Eligible Branches:</strong> ${c.branches || 'All branches'}</p>
              <p><strong>üë• Openings:</strong> ${c.openings || 'Multiple'} positions</p>
              <p><strong>üìß HR Contact:</strong> ${c.hrEmail || 'N/A'}</p>
              ${c.jobDescription ? `<p><strong>üìù Description:</strong> ${c.jobDescription}</p>` : ''}
            </div>
            ${alreadyApplied 
              ? '<button disabled style="background: #6c757d; cursor: not-allowed;">‚úÖ Already Applied</button>'
              : eligible 
                ? `<button onclick="applyToCompany(${c.id}, '${c.name}')" style="background: #28a745;">üöÄ Apply Now</button>`
                : '<button disabled style="background: #dc3545; cursor: not-allowed;">‚ùå Not Eligible</button>'
            }
          </div>
        `;
      });
      return html || '<p class="no-data">No companies available</p>';
    }

    // Apply to company
    async function applyToCompany(companyId, companyName) {
      if (!currentStudent.resumeFileName) {
        alert('‚ö†Ô∏è Please upload your resume before applying!');
        toggleUpdateForm();
        return;
      }
      
      if (!confirm(`Apply to ${companyName}?\n\nMake sure your profile is complete and up-to-date.`)) return;
      
      try {
        const res = await fetch('/api/student/apply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `companyId=${companyId}`
        });
        const data = await res.json();
        
        if (data.error) {
          alert('‚ùå Error: ' + data.error);
        } else {
          alert('‚úÖ Application submitted successfully! Track your status in "My Applications" section.');
          loadApplications();
          loadEligibleCompanies();
          loadAllCompanies();
        }
      } catch (e) {
        alert('‚ùå Error submitting application');
      }
    }

    function toggleUpdateForm() {
      const form = document.getElementById('updateForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      if (tab === 'eligible') {
        document.getElementById('eligibleTab').classList.add('active');
      } else {
        document.getElementById('allTab').classList.add('active');
      }
    }

    // Load all data on page load
    window.addEventListener('load', () => {
      checkAuth();
    });
  </script>
</body>
</html>
