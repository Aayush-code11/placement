<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Dashboard - Placement</title>
  <link rel="stylesheet" href="/css/dashboard.css" />
</head>
<body>
  <header>
    <h1>ğŸ“ Student Dashboard</h1>
    <nav>
      <a href="/">Home</a> | 
      <a href="#" onclick="logout(); return false;">Logout</a>
    </nav>
  </header>
  <main class="container">
    <div id="authRequired" class="auth-required" style="display: none;">
      <h2>ğŸ”’ Login Required</h2>
      <p>Please login or register to access the Student Dashboard</p>
      <div class="auth-buttons">
        <a href="/login.html" class="auth-btn login-btn">ğŸ” Login</a>
        <a href="/register.html" class="auth-btn register-btn">ğŸ“ Register as Student</a>
      </div>
    </div>

    <div id="dashboardContent" style="display: none;">
    
    <div class="stats">
      <div class="stat-card">
        <h2 id="totalApps">0</h2>
        <p>Total Applications</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h2 id="shortlistedCount">0</h2>
        <p>Shortlisted</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <h2 id="interviewedCount">0</h2>
        <p>Interviewed</p>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
        <h2 id="selectedCount">0</h2>
        <p>Selected</p>
      </div>
    </div>
    
    <div class="dashboard">
      <div class="card">
        <h3>ğŸ‘¤ My Profile</h3>
        <div id="profileInfo" class="profile-info">
          <p>Loading...</p>
        </div>
        <button onclick="toggleUpdateForm()" style="margin-top: 15px;">âœï¸ Update Profile</button>
        
        <div id="updateForm" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
          <h4>Update Academic & Personal Details</h4>
          <form action="/students" method="post" enctype="multipart/form-data">
            <input type="hidden" name="name" id="updateName">
            <input type="hidden" name="roll" id="updateRoll">
            <label>Branch/Department <input name="branch" id="updateBranch" required placeholder="e.g., Computer Science"></label>
            <label>CGPA <input name="cgpa" id="updateCgpa" required type="number" step="0.01" min="0" max="10" placeholder="e.g., 8.5"></label>
            <label>Email <input name="email" id="updateEmail" required type="email" placeholder="your.email@example.com"></label>
            <label>Upload Resume (PDF) <input name="resume" type="file" accept="application/pdf"></label>
            <button type="submit">ğŸ’¾ Save Changes</button>
          </form>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ“‹ My Applications & Status</h3>
        <div id="applicationsStatus">
          <p class="no-data">Loading...</p>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <h3>ğŸ¢ Job Opportunities & Placement Drives</h3>
      
      <div class="tabs">
        <button class="tab active" onclick="switchTab('eligible')">âœ… Eligible for Me</button>
        <button class="tab" onclick="switchTab('all')">ğŸ“‹ All Companies</button>
      </div>
      
      <div id="eligibleTab" class="tab-content active">
        <p style="color: #666; font-size: 14px; margin: 15px 0;">Companies matching your CGPA and department eligibility.</p>
        <div id="eligibleCompanies">
          <p class="no-data">Loading...</p>
        </div>
      </div>
      
      <div id="allTab" class="tab-content">
        <p style="color: #666; font-size: 14px; margin: 15px 0;">All available job opportunities (eligibility criteria shown).</p>
        <div id="allCompanies">
          <p class="no-data">Loading...</p>
        </div>
      </div>
    </div>

    </div>

  </main>
  
  <script>
    let currentStudent = null;
    let isAuthenticated = false;
    let allCompaniesData = [];
    let appliedCompanyIds = [];

    function logout() {
      sessionStorage.clear();
      window.location.href = '/';
    }

    async function checkAuth() {
      const username = sessionStorage.getItem('username');
      const role = sessionStorage.getItem('role');
      
      if (username && role === 'STUDENT') {
        document.getElementById('authRequired').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        isAuthenticated = true;
        loadProfile();
        loadApplications();
        loadEligibleCompanies();
        loadAllCompanies();
      } else {
        document.getElementById('authRequired').style.display = 'block';
        document.getElementById('dashboardContent').style.display = 'none';
        isAuthenticated = false;
      }
    }

    async function loadProfile() {
      try {
        const res = await fetch('/api/student/me');
        const data = await res.json();
        
        if (data.error) {
          currentStudent = { name: sessionStorage.getItem('username'), roll: '', branch: '', cgpa: 0, email: '', resumeFileName: null };
          document.getElementById('profileInfo').innerHTML = `
            <p><strong>Name:</strong> ${currentStudent.name}</p>
            <p><strong>Roll No:</strong> <span style="color: #999;">Not set</span></p>
            <p><strong>Department:</strong> <span style="color: #999;">Not set</span></p>
            <p><strong>CGPA:</strong> <span style="color: #999;">Not set</span></p>
            <p><strong>Email:</strong> <span style="color: #999;">Not set</span></p>
            <p><strong>Resume:</strong> âŒ Not uploaded</p>
            <p style="color: #ff6b6b; margin-top: 10px;">âš ï¸ Please update your profile to apply for companies</p>
          `;
          
          document.getElementById('updateName').value = currentStudent.name;
          document.getElementById('updateRoll').value = '';
          document.getElementById('updateBranch').value = '';
          document.getElementById('updateCgpa').value = '';
          document.getElementById('updateEmail').value = '';
          return;
        }
        
        currentStudent = data;
        document.getElementById('profileInfo').innerHTML = `
          <p><strong>Name:</strong> ${data.name || 'N/A'}</p>
          <p><strong>Roll No:</strong> ${data.roll || 'N/A'}</p>
          <p><strong>Department:</strong> ${data.branch || 'N/A'}</p>
          <p><strong>CGPA:</strong> ${data.cgpa || 'N/A'}</p>
          <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
          <p><strong>Resume:</strong> ${data.resumeFileName ? 'âœ… Uploaded' : 'âŒ Not uploaded'}</p>
        `;
        
        document.getElementById('updateName').value = data.name || '';
        document.getElementById('updateRoll').value = data.roll || '';
        document.getElementById('updateBranch').value = data.branch || '';
        document.getElementById('updateCgpa').value = data.cgpa || '';
        document.getElementById('updateEmail').value = data.email || '';
      } catch (e) {
        document.getElementById('profileInfo').innerHTML = `<p style="color: red;">Error loading profile</p>`;
      }
    }

    async function loadApplications() {
      try {
        const res = await fetch('/api/student/my-applications');
        const apps = await res.json();
        
        document.getElementById('totalApps').textContent = apps.length || 0;
        document.getElementById('shortlistedCount').textContent = apps.filter(a => a.status === 'Shortlisted').length;
        document.getElementById('interviewedCount').textContent = apps.filter(a => a.status === 'Interviewed').length;
        document.getElementById('selectedCount').textContent = apps.filter(a => a.status === 'Selected').length;
        
        appliedCompanyIds = apps.map(a => a.company?.id).filter(id => id);
        
        if (!apps || apps.length === 0) {
          document.getElementById('applicationsStatus').innerHTML = '<p class="no-data">No applications yet. Start applying to companies!</p>';
          return;
        }
        
        let html = '<div style="max-height: 300px; overflow-y: auto;">';
        apps.forEach(app => {
          const statusClass = `status-${app.status.toLowerCase().replace(' ', '-')}`;
          const statusIcon = {
            'Applied': 'ğŸ“',
            'Shortlisted': 'âœ…',
            'Interviewed': 'ğŸ¤',
            'Selected': 'ğŸ‰',
            'Rejected': 'âŒ'
          };
          html += `
            <div style="background: white; padding: 12px; margin: 8px 0; border-radius: 5px; border-left: 3px solid #007bff;">
              <strong>${app.company?.name || 'Company'}</strong>
              <p style="margin: 5px 0; color: #666; font-size: 13px;">${app.company?.role || 'Position'}</p>
              <span class="app-status ${statusClass}">${statusIcon[app.status] || 'ğŸ“Œ'} ${app.status}</span>
            </div>
          `;
        });
        html += '</div>';
        document.getElementById('applicationsStatus').innerHTML = html;
      } catch (e) {
        document.getElementById('applicationsStatus').innerHTML = '<p class="no-data">Error loading applications</p>';
      }
    }

    function isEligible(company) {
      if (!currentStudent) return false;
      if (!currentStudent.cgpa || !currentStudent.branch) return false;
      
      const studentCgpa = parseFloat(currentStudent.cgpa) || 0;
      const minCgpa = parseFloat(company.minCgpa) || 0;
      const branches = (company.eligibleBranches || '').toLowerCase().split(',').map(b => b.trim());
      const studentBranch = (currentStudent.branch || '').toLowerCase().trim();
      
      const cgpaOk = studentCgpa >= minCgpa;
      const branchOk = !company.eligibleBranches || company.eligibleBranches === '' || branches.includes(studentBranch) || branches.includes('all');
      
      return cgpaOk && branchOk;
    }

    async function loadEligibleCompanies() {
      try {
        const res = await fetch('/api/student/eligible-companies');
        const companies = await res.json();
        if (!companies || companies.length === 0) {
          document.getElementById('eligibleCompanies').innerHTML = '<p class="no-data">No companies available matching your profile. Keep checking for new opportunities!</p>';
          return;
        }
        
        document.getElementById('eligibleCompanies').innerHTML = renderCompanies(companies, true);
      } catch (e) {
        document.getElementById('eligibleCompanies').innerHTML = '<p class="no-data">Error loading companies</p>';
      }
    }

    async function loadAllCompanies() {
      try {
        const res = await fetch('/api/companies');
        const companies = await res.json();
        allCompaniesData = companies;
        if (!companies || companies.length === 0) {
          document.getElementById('allCompanies').innerHTML = '<p class="no-data">No companies posted yet</p>';
          return;
        }
        
        document.getElementById('allCompanies').innerHTML = renderCompanies(companies, false);
      } catch (e) {
        document.getElementById('allCompanies').innerHTML = '<p class="no-data">Error loading companies</p>';
      }
    }

    function renderCompanies(companies, onlyEligible) {
      let html = '';
      companies.forEach(c => {
        const eligible = isEligible(c);
        const alreadyApplied = appliedCompanyIds.includes(c.id);
        
        if (onlyEligible && !eligible) return;
        
        html += `
          <div class="company-card">
            <h4>ğŸ¢ ${c.name} ${eligible ? '<span class="eligibility-badge eligible">âœ… Eligible</span>' : '<span class="eligibility-badge not-eligible">âŒ Not Eligible</span>'}</h4>
            <div class="job-details">
              <p><strong>ğŸ“Œ Position:</strong> ${c.jobRole || 'N/A'}</p>
              <p><strong>ğŸ’° Package (CTC):</strong> ${c.ctc || 'Not disclosed'}</p>
              <p><strong>ğŸ“ Location:</strong> ${c.location || 'Not specified'}</p>
              <p><strong>ğŸ¯ Min CGPA Required:</strong> ${c.minCgpa || 'N/A'}</p>
              <p><strong>ğŸ“ Eligible Branches:</strong> ${c.eligibleBranches || 'All branches'}</p>
              <p><strong>ğŸ‘¥ Openings:</strong> ${c.openings || 'Multiple'} positions</p>
              <p><strong>ğŸ“§ HR Contact:</strong> ${c.hrEmail || 'N/A'}</p>
              ${c.jobDescription ? `<p><strong>ğŸ“ Description:</strong> ${c.jobDescription}</p>` : ''}
            </div>
            ${alreadyApplied 
              ? '<button disabled style="background: #6c757d; cursor: not-allowed;">âœ… Already Applied</button>'
              : eligible 
                ? `<button onclick="applyToCompany(${c.id}, '${c.name}')" style="background: #28a745;">ğŸš€ Apply Now</button>`
                : '<button disabled style="background: #dc3545; cursor: not-allowed;">âŒ Not Eligible</button>'
            }
          </div>
        `;
      });
      return html || '<p class="no-data">No companies available</p>';
    }

    async function applyToCompany(companyId, companyName) {
      if (!currentStudent.resumeFileName) {
        alert('âš ï¸ Please upload your resume before applying!');
        toggleUpdateForm();
        return;
      }
      
      if (!confirm(`Apply to ${companyName}?\n\nMake sure your profile is complete and up-to-date.`)) return;
      
      try {
        const res = await fetch('/api/student/apply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `companyId=${companyId}`
        });
        const data = await res.json();
        
        if (data.error) {
          alert('âŒ Error: ' + data.error);
        } else {
          alert('âœ… Application submitted successfully! Track your status in "My Applications" section.');
          loadApplications();
          loadEligibleCompanies();
          loadAllCompanies();
        }
      } catch (e) {
        alert('âŒ Error submitting application');
      }
    }

    function toggleUpdateForm() {
      const form = document.getElementById('updateForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
      if (tab === 'eligible') {
        document.getElementById('eligibleTab').classList.add('active');
      } else {
        document.getElementById('allTab').classList.add('active');
      }
    }

    window.addEventListener('load', () => {
      checkAuth();
    });
  </script>
</body>
</html>
